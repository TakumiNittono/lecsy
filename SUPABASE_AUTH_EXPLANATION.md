# Supabaseèªè¨¼ã®ä»•çµ„ã¿

## âœ… ã¯ã„ã€Supabaseã«è‡ªå‹•ç™»éŒ²ã•ã‚Œã¾ã™ï¼

Google/Appleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€**Supabaseã®`auth.users`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è‡ªå‹•çš„ã«ç™»éŒ²**ã•ã‚Œã¾ã™ã€‚

---

## ğŸ”„ èªè¨¼ãƒ•ãƒ­ãƒ¼ã®æµã‚Œ

### 1. åˆå›ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogle/Appleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
    â†“
Supabase AuthãŒOAuthèªè¨¼ã‚’å‡¦ç†
    â†“
auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã«è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
    â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (UUID) ãŒç”Ÿæˆã•ã‚Œã‚‹
    â†“
ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¢ºç«‹ã•ã‚Œã‚‹
```

### 2. 2å›ç›®ä»¥é™ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogle/Appleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
    â†“
Supabase AuthãŒæ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    â†“
æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
    â†“
ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¢ºç«‹ã•ã‚Œã‚‹
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

### auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSupabaseç®¡ç†ï¼‰

SupabaseãŒè‡ªå‹•çš„ã«ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼š

```sql
auth.users (
    id: UUID (ä¸»ã‚­ãƒ¼)
    email: TEXT
    email_confirmed_at: TIMESTAMPTZ
    created_at: TIMESTAMPTZ
    updated_at: TIMESTAMPTZ
    raw_app_meta_data: JSONB
    raw_user_meta_data: JSONB
    ...
)
```

**é‡è¦**: ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯**SupabaseãŒè‡ªå‹•ç®¡ç†**ã™ã‚‹ãŸã‚ã€ç›´æ¥æ“ä½œã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`transcripts`, `summaries`ãªã©ï¼‰ã¯ã€`auth.users`ã‚’å‚ç…§ã—ã¾ã™ï¼š

```sql
CREATE TABLE transcripts (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    -- ä»–ã®ã‚«ãƒ©ãƒ ...
);
```

**`user_id`ã§`auth.users`ã‚’å‚ç…§**ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ç´ä»˜ã‘ã¾ã™ã€‚

---

## ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ã®ä»•çµ„ã¿

### Row Level Security (RLS)

RLSãƒãƒªã‚·ãƒ¼ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼š

```sql
CREATE POLICY "Users can view own transcripts"
    ON transcripts FOR SELECT
    USING (auth.uid() = user_id);
```

**`auth.uid()`**: ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’è¿”ã™é–¢æ•°

### ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã®æµã‚Œ

1. **iOSã‚¢ãƒ—ãƒªã‹ã‚‰ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
   ```swift
   // SyncService.swift
   let response = try await supabase.functions.invoke("save-transcript", ...)
   ```

2. **Edge Functionã§èªè¨¼ãƒã‚§ãƒƒã‚¯**
   ```typescript
   // save-transcript/index.ts
   const { data: { user } } = await supabase.auth.getUser();
   // user.id ãŒå–å¾—ã§ãã‚‹
   ```

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜**
   ```typescript
   await supabase.from("transcripts").insert({
       user_id: user.id,  // auth.usersã®IDã‚’ä½¿ç”¨
       content: "...",
       ...
   });
   ```

---

## ğŸ“ å®Ÿéš›ã®å‹•ä½œä¾‹

### ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³

1. **Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³**
   - SupabaseãŒ`auth.users`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: `abc-123-def-456` (UUID)

2. **æ–‡å­—èµ·ã“ã—ã‚’ä¿å­˜**
   - `transcripts`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
   - `user_id: abc-123-def-456` ã§ç´ä»˜ã‘

3. **Webã‚¢ãƒ—ãƒªã§ç¢ºèª**
   - åŒã˜Supabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
   - `auth.uid() = abc-123-def-456` ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º

### ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼BãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³

1. **Appleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³**
   - SupabaseãŒ`auth.users`ã«åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: `xyz-789-uvw-012` (UUID)

2. **ãƒ‡ãƒ¼ã‚¿ã®åˆ†é›¢**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ãˆãªã„ï¼ˆRLSã§ä¿è­·ï¼‰
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

---

## ğŸ” Supabase Dashboardã§ç¢ºèªã™ã‚‹æ–¹æ³•

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’ç¢ºèª

1. Supabase Dashboardã«ãƒ­ã‚°ã‚¤ãƒ³
2. **Authentication** > **Users** ã‚’é–‹ã
3. ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèª

å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

- **User ID**: UUIDï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ä½¿ç”¨ã•ã‚Œã‚‹IDï¼‰
- **Email**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- **Provider**: `google` ã¾ãŸã¯ `apple`
- **Created At**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥æ™‚
- **Last Sign In**: æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç¢ºèª

**SQL Editor**ã§ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œï¼š

```sql
-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºèª
SELECT id, email, created_at, last_sign_in_at 
FROM auth.users;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®æ–‡å­—èµ·ã“ã—æ•°ã‚’ç¢ºèª
SELECT 
    u.email,
    COUNT(t.id) as transcript_count
FROM auth.users u
LEFT JOIN transcripts t ON u.id = t.user_id
GROUP BY u.id, u.email;
```

---

## âš ï¸ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•ä½œæˆã•ã‚Œã‚‹

- **æ‰‹å‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“**
- OAuthã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã«è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ä¸€æ„

- å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä¸€æ„ã®UUIDãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™
- ã“ã®IDã¯å¤‰æ›´ã§ãã¾ã›ã‚“

### 3. ãƒ‡ãƒ¼ã‚¿ã®åˆ†é›¢

- RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™
- ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ãˆã¾ã›ã‚“

### 4. å‰Šé™¤æ™‚ã®å‹•ä½œ

```sql
REFERENCES auth.users(id) ON DELETE CASCADE
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã‚‹ã¨ã€é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚‚è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

---

## ğŸ¯ ã¾ã¨ã‚

| é …ç›® | èª¬æ˜ |
|------|------|
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²** | Google/Appleã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã«è‡ªå‹•çš„ã«`auth.users`ã«ç™»éŒ²ã•ã‚Œã‚‹ |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ID** | SupabaseãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹UUID |
| **ãƒ‡ãƒ¼ã‚¿ç´ä»˜ã‘** | `user_id`ã§`auth.users`ã‚’å‚ç…§ |
| **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢** | RLSãƒãƒªã‚·ãƒ¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢ |
| **ç¢ºèªæ–¹æ³•** | Supabase Dashboard > Authentication > Users |

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)

---

**æœ€çµ‚æ›´æ–°**: 2026å¹´1æœˆ27æ—¥
