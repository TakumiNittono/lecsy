# ãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰ â€” Stripe èª²é‡‘ãƒ•ãƒ­ãƒ¼

**ä½œæˆæ—¥**: 2026å¹´2æœˆ6æ—¥

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Stripeèª²é‡‘ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ“‹ å‰ææ¡ä»¶

### 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

#### Vercelï¼ˆNext.js Web ã‚¢ãƒ—ãƒªï¼‰

Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ â†’ **Settings** â†’ **Environment Variables** ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```env
# Stripeï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒï¼‰
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxx         # Stripe Test Secret Key
STRIPE_PRICE_ID=price_xxxxxxxxxxxxx             # ãƒ†ã‚¹ãƒˆç”¨Price ID
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxxx # Stripe Test Publishable Key

# App URL
NEXT_PUBLIC_APP_URL=http://localhost:3000        # ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨
# ã¾ãŸã¯
NEXT_PUBLIC_APP_URL=https://your-preview-url.vercel.app  # Previewç’°å¢ƒç”¨
```

#### Supabase Edge Functions

Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ **Edge Functions** â†’ **Secrets** ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```env
# Stripeï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒï¼‰
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxx       # Stripe CLIã§å–å¾—ï¼ˆå¾Œè¿°ï¼‰

# OpenAIï¼ˆãƒ†ã‚¹ãƒˆç”¨ - å®Ÿéš›ã®APIã‚­ãƒ¼ã§ã‚‚OKï¼‰
OPENAI_API_KEY=sk-xxxxxxxxxxxxx
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ‰‹é †

### Step 1: Stripe ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æº–å‚™

1. [Stripe ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dashboard.stripe.com/test/dashboard) ã«ãƒ­ã‚°ã‚¤ãƒ³
2. **Test mode** ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆå³ä¸Šã®ãƒˆã‚°ãƒ«ï¼‰

### Step 2: ãƒ†ã‚¹ãƒˆç”¨ Product & Price ã®ä½œæˆ

1. Stripe ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ **Products** â†’ **Add Product**
2. ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ï¼š

| é …ç›® | å€¤ |
|------|-----|
| **Product name** | lecsy Pro (Test) |
| **Description** | Test subscription for lecsy Pro |
| **Pricing model** | Recurring |
| **Price** | $2.99 |
| **Billing period** | Monthly |
| **Currency** | USD |

3. ä½œæˆå¾Œã€**Price ID** ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ`price_xxxxxxxxxxxxx` ã®å½¢å¼ï¼‰
4. ã“ã® Price ID ã‚’ Vercel ã®ç’°å¢ƒå¤‰æ•° `STRIPE_PRICE_ID` ã«è¨­å®š

### Step 3: Stripe CLI ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆWebhook ãƒ†ã‚¹ãƒˆç”¨ï¼‰

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# macOS
brew install stripe/stripe-cli/stripe

# ãã®ä»–ã®OS
# https://stripe.com/docs/stripe-cli#install
```

#### ãƒ­ã‚°ã‚¤ãƒ³

```bash
stripe login
```

#### Webhook ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«è»¢é€

```bash
# Supabase Edge Function ã®ãƒ­ãƒ¼ã‚«ãƒ«URLã«è»¢é€
stripe listen --forward-to http://localhost:54321/functions/v1/stripe-webhook

# ã¾ãŸã¯ã€Supabase ã®æœ¬ç•ªURLã«è»¢é€ï¼ˆPreviewç’°å¢ƒãƒ†ã‚¹ãƒˆæ™‚ï¼‰
stripe listen --forward-to https://<PROJECT_REF>.supabase.co/functions/v1/stripe-webhook
```

**é‡è¦**: ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`whsec_xxxxxxxxxxxxx` ã¨ã„ã† **Webhook Signing Secret** ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’ Supabase ã®ç’°å¢ƒå¤‰æ•° `STRIPE_WEBHOOK_SECRET` ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

### Step 4: ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ

#### ãƒ†ã‚¹ãƒˆç”¨ã‚«ãƒ¼ãƒ‰ç•ªå·

| ã‚«ãƒ¼ãƒ‰ç•ªå· | çµæœ |
|-----------|------|
| `4242 4242 4242 4242` | âœ… æˆåŠŸ |
| `4000 0000 0000 3220` | âš ï¸ 3Dã‚»ã‚­ãƒ¥ã‚¢èªè¨¼ãŒå¿…è¦ |
| `4000 0000 0000 0002` | âŒ ã‚«ãƒ¼ãƒ‰æ‹’å¦ |
| `4000 0000 0000 9995` | âŒ æ®‹é«˜ä¸è¶³ |

**æœ‰åŠ¹æœŸé™**: æœªæ¥ã®ä»»æ„ã®æ—¥ä»˜ï¼ˆä¾‹: `12/34`ï¼‰  
**CVC**: ä»»æ„ã®3æ¡ï¼ˆä¾‹: `123`ï¼‰  
**éƒµä¾¿ç•ªå·**: ä»»æ„ï¼ˆä¾‹: `12345`ï¼‰

#### ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

1. **Webã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹** â†’ `/login` ã§ãƒ­ã‚°ã‚¤ãƒ³
2. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** (`/app`) ã«ç§»å‹•
3. **Subscription ã‚«ãƒ¼ãƒ‰** ã‚’ç¢ºèª â†’ "Free" ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. **"Upgrade to Pro â€” $2.99/mo"** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. **Stripe Checkout ãƒšãƒ¼ã‚¸**ãŒé–‹ã
6. **ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰** `4242 4242 4242 4242` ã‚’å…¥åŠ›
   - æœ‰åŠ¹æœŸé™: `12/34`
   - CVC: `123`
   - éƒµä¾¿ç•ªå·: `12345`
7. **"Subscribe"** ã‚’ã‚¯ãƒªãƒƒã‚¯
8. **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ** â†’ `/app?success=true` ã«æˆ»ã‚‹
9. **ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥** â†’ "Welcome to Pro! AI features are now available." ãŒè¡¨ç¤ºã•ã‚Œã‚‹
10. **Subscription ã‚«ãƒ¼ãƒ‰** ã‚’å†ç¢ºèª â†’ "Pro" ã¨è¡¨ç¤ºã•ã‚Œã€æ¬¡å›æ›´æ–°æ—¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### Step 5: Webhook ã®å‹•ä½œç¢ºèª

#### Stripe CLI ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºèª

`stripe listen` ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ï¼š

```
2026-02-06 12:34:56   --> checkout.session.completed [evt_xxxxx]
2026-02-06 12:34:57   <-- [200] POST http://localhost:54321/functions/v1/stripe-webhook [evt_xxxxx]
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª

Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ **Table Editor** â†’ `subscriptions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªï¼š

- `user_id`: ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- `status`: `active`
- `stripe_customer_id`: `cus_xxxxx`
- `stripe_subscription_id`: `sub_xxxxx`
- `current_period_start`: ç¾åœ¨ã®æ—¥æ™‚
- `current_period_end`: 1ãƒ¶æœˆå¾Œã®æ—¥æ™‚

### Step 6: Pro æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

1. **ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸** (`/app/t/[id]`) ã«ç§»å‹•
2. **"AI Summary"** ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
3. **Pro ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ**:
   - "Use AI Summary" ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ŒPro feature is available!ã€ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. **Free ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ**ï¼ˆåˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ†ã‚¹ãƒˆï¼‰:
   - "Upgrade to Pro" ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ Checkout ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

### Step 7: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒ†ã‚¹ãƒˆ

1. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** (`/app`) ã«ç§»å‹•
2. **Subscription ã‚«ãƒ¼ãƒ‰** ã® **"Manage Subscription"** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **Stripe Customer Portal** ãŒé–‹ã
4. **"Cancel subscription"** ã‚’ã‚¯ãƒªãƒƒã‚¯
5. **æœŸé–“çµ‚äº†æ™‚ã«è§£ç´„** ã‚’é¸æŠ
6. **ç¢ºèª** â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
7. **Subscription ã‚«ãƒ¼ãƒ‰** ã‚’ç¢ºèª â†’ "âš ï¸ Cancels on [æ—¥ä»˜]" ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Checkout Session ä½œæˆã«å¤±æ•—ã™ã‚‹

**ç—‡çŠ¶**: "Failed to create checkout session" ã‚¨ãƒ©ãƒ¼

**åŸå› ã¨å¯¾ç­–**:
- âœ… `STRIPE_SECRET_KEY` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- âœ… `STRIPE_PRICE_ID` ãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆ`price_` ã§å§‹ã¾ã‚‹ï¼‰
- âœ… Vercel ã®ç’°å¢ƒå¤‰æ•°ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆå†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰

### Webhook ãŒå±Šã‹ãªã„

**ç—‡çŠ¶**: æ±ºæ¸ˆã¯æˆåŠŸã™ã‚‹ãŒã€`subscriptions` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ›´æ–°ã•ã‚Œãªã„

**åŸå› ã¨å¯¾ç­–**:
- âœ… `stripe listen` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- âœ… `STRIPE_WEBHOOK_SECRET` ãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆ`whsec_` ã§å§‹ã¾ã‚‹ï¼‰
- âœ… Supabase Edge Function ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- âœ… Stripe CLI ã®ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

### Pro çŠ¶æ…‹ãŒåæ˜ ã•ã‚Œãªã„

**ç—‡çŠ¶**: æ±ºæ¸ˆæˆåŠŸå¾Œã‚‚ "Free" ã¨è¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› ã¨å¯¾ç­–**:
- âœ… ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œï¼‰
- âœ… `subscriptions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç›´æ¥ç¢ºèª
- âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

### ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶**: `/app?success=true` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ãŒé€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› ã¨å¯¾ç­–**:
- âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
- âœ… `ToastProvider` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆå®Œäº†ã®ç¢ºèªé …ç›®ï¼š

- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆãŒæˆåŠŸã™ã‚‹
- [ ] Checkout å®Œäº†å¾Œã€`/app?success=true` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- [ ] ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `subscriptions` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `status: "active"` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® Subscription ã‚«ãƒ¼ãƒ‰ãŒ "Pro" ã«å¤‰ã‚ã‚‹
- [ ] ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã§ "Use AI Summary" ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] Customer Portal ã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãŒã§ãã‚‹
- [ ] è§£ç´„æ“ä½œãŒæ­£ã—ãåæ˜ ã•ã‚Œã‚‹

---

## ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ç§»è¡Œ

ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ãŸã‚‰ã€æœ¬ç•ªç’°å¢ƒã«ç§»è¡Œï¼š

1. **Stripe ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** ã§ **Live mode** ã«åˆ‡ã‚Šæ›¿ãˆ
2. **æœ¬ç•ªç”¨ Product & Price** ã‚’ä½œæˆ
3. **æœ¬ç•ªç”¨ Webhook** ã‚’ç™»éŒ²ï¼ˆSupabase ã®æœ¬ç•ªURLï¼‰
4. **ç’°å¢ƒå¤‰æ•°ã‚’æœ¬ç•ªç”¨ã«æ›´æ–°**:
   - `sk_test_xxx` â†’ `sk_live_xxx`
   - `pk_test_xxx` â†’ `pk_live_xxx`
   - ãƒ†ã‚¹ãƒˆç”¨ Price ID â†’ æœ¬ç•ªç”¨ Price ID
5. **Vercel ã¨ Supabase ã«æœ¬ç•ªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š**
6. **å†ãƒ‡ãƒ—ãƒ­ã‚¤**

---

**æœ€çµ‚æ›´æ–°**: 2026å¹´2æœˆ6æ—¥
