# Unlimited - アプリ詳細ドキュメント

## 📋 目次

1. [概要](#概要)
2. [主要機能](#主要機能)
3. [技術仕様](#技術仕様)
4. [アーキテクチャ](#アーキテクチャ)
5. [ファイル構造](#ファイル構造)
6. [主要コンポーネント](#主要コンポーネント)
7. [設定と権限](#設定と権限)
8. [多言語対応](#多言語対応)
9. [Live Activities](#live-activities)
10. [バックグラウンド処理](#バックグラウンド処理)
11. [データモデル](#データモデル)
12. [依存関係](#依存関係)

---

## 概要

**Unlimited**は、大学の講義音声を**完全無料・完全ローカル**で録音・文字起こしするiOSアプリです。

### 特徴

- ✅ **完全無料**: Whisper APIやクラウドサービスは一切使用しません
- ✅ **完全ローカル**: すべての処理はiPhone上で実行されます
- ✅ **バックグラウンド録音**: ロック画面でも録音が継続します
- ✅ **Live Activities**: ロック画面とDynamic Islandで録音状態を表示
- ✅ **多言語対応**: 日本語・英語のUIと文字起こし言語選択
- ✅ **オフライン動作**: 初回モデルダウンロード後は完全オフラインで動作

---

## 主要機能

### 1. 音声録音機能

- **リアルタイム録音**: マイクから直接音声を録音
- **バックグラウンド録音**: ロック画面やバックグラウンドでも継続
- **ストップウォッチ表示**: ミリ秒単位の経過時間表示
- **録音ファイル管理**: 録音履歴の一覧表示・削除

### 2. 文字起こし機能

- **WhisperKit統合**: ローカルで高精度な文字起こし
- **言語選択**: 自動検出・日本語・英語から選択可能
- **進捗表示**: モデル読み込み・処理中の進捗表示
- **結果表示**: 整形されたテキスト結果の表示・コピー・共有

### 3. Live Activities

- **ロック画面表示**: 録音中はロック画面に時間と状態を表示
- **Dynamic Island対応**: iPhone 14 Pro以降でDynamic Islandに表示
- **タップで停止**: ロック画面から直接録音を停止可能

### 4. 多言語対応

- **UI言語**: 日本語・英語を切り替え可能
- **文字起こし言語**: 自動検出・日本語・英語から選択
- **動的言語切り替え**: アプリ内で即座に言語変更

---

## 技術仕様

### プラットフォーム

- **OS**: iOS 17.6以上
- **デバイス**: iPhone（iPad対応も可能）
- **推奨端末**: iPhone 14 Pro以降（メモリと処理性能のため）

### 開発環境

- **言語**: Swift 5.0
- **UIフレームワーク**: SwiftUI
- **最小デプロイメントターゲット**: iOS 17.6
- **パッケージ管理**: Swift Package Manager

### バンドル情報

- **メインアプリ**: `com.takumiNittono.word.Unlimited`
- **ウィジェット拡張**: `com.takumiNittono.word.Unlimited.UnlimitedWidget`
- **App Group**: `group.com.takumiNittono.word.Unlimited`

---

## アーキテクチャ

### アーキテクチャパターン

- **MVVM**: Model-View-ViewModelパターンを採用
- **ObservableObject**: SwiftUIの`@Published`と`@ObservedObject`で状態管理
- **Singleton**: `TranscriptionService`と`LanguageManager`はシングルトン

### 状態管理

- **RecordingService**: 録音状態とタイマーを管理（`@MainActor`）
- **TranscriptionService**: 文字起こし状態と進捗を管理（`@MainActor`）
- **RecordingStore**: 録音履歴の永続化（`UserDefaults`）
- **LanguageManager**: アプリ言語設定の管理

### データフロー

```
ユーザー操作
    ↓
View (SwiftUI)
    ↓
Service (ObservableObject)
    ↓
Model (Codable)
    ↓
永続化 (UserDefaults / FileManager)
```

---

## ファイル構造

```
Unlimited/
├── UnlimitedApp.swift              # アプリエントリーポイント
├── ContentView.swift               # メインコンテンツビュー（TabView）
├── UnlimitedWidgetAttributes.swift # Live Activities属性定義
│
├── Models/                         # データモデル
│   ├── RecordingItem.swift        # 録音アイテム
│   ├── TranscriptionResult.swift  # 文字起こし結果
│   └── TranscriptionLanguage.swift # 文字起こし言語
│
├── Services/                      # ビジネスロジック
│   ├── RecordingService.swift     # 録音サービス
│   ├── RecordingStore.swift       # 録音履歴管理
│   ├── TranscriptionService.swift # 文字起こしサービス
│   └── LanguageManager.swift      # 言語管理
│
├── Views/                         # UIコンポーネント
│   ├── RecordingListView.swift    # 録音一覧
│   ├── ResultView.swift          # 文字起こし結果表示
│   └── SettingsView.swift        # 設定画面
│
└── Utils/                        # ユーティリティ
    └── LocalizedString.swift     # 多言語文字列

UnlimitedWidget/                  # ウィジェット拡張
├── UnlimitedWidget.swift         # 標準ウィジェット
├── UnlimitedWidgetBundle.swift   # ウィジェットバンドル
└── UnlimitedWidgetLiveActivity.swift # Live Activities UI
```

---

## 主要コンポーネント

### 1. RecordingService

**役割**: 音声録音の管理

**主要機能**:
- マイク権限の確認とリクエスト
- AVAudioRecorderによる録音
- バックグラウンド録音対応
- Live Activitiesの開始・更新・終了
- ロック画面コントロール（MPRemoteCommandCenter）
- タイマー管理（開始時刻ベース）

**主要プロパティ**:
```swift
@Published var isRecording: Bool
@Published var recordingDuration: TimeInterval
private var audioRecorder: AVAudioRecorder?
private var liveActivity: Activity<UnlimitedWidgetAttributes>?
private var recordingStartTime: Date?
```

**主要メソッド**:
- `startRecording()`: 録音開始
- `stopRecording()`: 録音停止
- `startLiveActivity()`: Live Activity開始
- `updateLiveActivity()`: Live Activity更新
- `formattedStopwatch()`: ストップウォッチ形式の時間表示

### 2. TranscriptionService

**役割**: WhisperKitを使用した文字起こし

**主要機能**:
- WhisperKitモデルの読み込み
- 音声ファイルの文字起こし
- 進捗状況の追跡
- 言語選択（自動検出・日本語・英語）

**主要プロパティ**:
```swift
@Published var state: TranscriptionState
@Published var progress: Double
@Published var transcriptionLanguage: TranscriptionLanguage
private var whisperKit: WhisperKit?
static let shared = TranscriptionService()
```

**主要メソッド**:
- `loadModel()`: WhisperKitモデルの読み込み
- `transcribe(audioURL:)`: 音声ファイルの文字起こし

### 3. RecordingStore

**役割**: 録音履歴の永続化と管理

**主要機能**:
- 録音アイテムの追加・更新・削除
- UserDefaultsへの保存
- ファイル存在確認

**主要プロパティ**:
```swift
@Published var recordings: [RecordingItem]
private let storageKey = "saved_recordings"
```

**主要メソッド**:
- `addRecording(_:)`: 録音を追加
- `updateRecording(_:)`: 録音を更新
- `deleteRecording(_:)`: 録音を削除
- `loadRecordings()`: 保存された録音を読み込み

### 4. LanguageManager

**役割**: アプリの言語設定管理

**主要機能**:
- アプリ言語の設定・取得
- UserDefaultsとApp Groupへの保存
- システム言語の自動検出

**主要プロパティ**:
```swift
@Published var currentLanguage: AppLanguage
static let shared = LanguageManager()
```

**主要メソッド**:
- `setLanguage(_:)`: 言語を設定

### 5. LocalizedString

**役割**: 多言語対応の文字列管理

**実装方法**:
- `LanguageManager.shared.currentLanguage`を参照
- 各プロパティで日本語・英語を返す

**例**:
```swift
static var recording: String {
    currentLanguage == .japanese ? "録音" : "Recording"
}
```

---

## 設定と権限

### Info.plist設定

#### メインアプリ

- **NSSupportsLiveActivities**: `YES` - Live Activities対応
- **UIBackgroundModes**: `audio` - バックグラウンド録音
- **NSMicrophoneUsageDescription**: "講義の音声を録音して文字起こしするためにマイクへのアクセスが必要です。"
- **CFBundleURLTypes**: 
  - Scheme: `unlimited`
  - URL Name: `com.takumiNittono.word.Unlimited`

#### ウィジェット拡張

- **NSSupportsLiveActivities**: `YES` - Live Activities対応

### 必要な権限

1. **マイク権限**: 録音機能に必要
   - iOS 17.0以降: `AVAudioApplication.requestRecordPermission()`
   - iOS 17.0未満: `AVAudioSession.requestRecordPermission()`

2. **バックグラウンド録音**: Info.plistの`UIBackgroundModes`に`audio`を設定

3. **Live Activities**: Info.plistの`NSSupportsLiveActivities`を`YES`に設定

---

## 多言語対応

### 対応言語

- **日本語** (`ja`)
- **英語** (`en`)

### 実装方法

1. **LanguageManager**: アプリ全体の言語設定を管理
2. **LocalizedString**: 各UI文字列を動的に切り替え
3. **App Group**: ウィジェット拡張とメインアプリ間で言語設定を共有

### 言語設定の保存場所

- `UserDefaults.standard`: メインアプリ用
- `UserDefaults(suiteName: "group.com.takumiNittono.word.Unlimited")`: App Group用（ウィジェット拡張と共有）

### 文字起こし言語

- **自動検出**: WhisperKitが自動的に言語を判定
- **日本語**: 日本語として処理
- **英語**: 英語として処理

---

## Live Activities

### 機能概要

録音中にロック画面とDynamic Islandに録音状態を表示します。

### 実装詳細

#### UnlimitedWidgetAttributes

```swift
struct UnlimitedWidgetAttributes: ActivityAttributes {
    public struct ContentState: Codable, Hashable {
        var recordingDuration: TimeInterval
        var isRecording: Bool
    }
    var fileName: String
}
```

#### UIコンポーネント

1. **ロック画面UI**: 
   - 録音アイコン（パルスアニメーション）
   - 録音状態テキスト
   - ストップウォッチ形式の時間表示

2. **Dynamic Island**:
   - **Expanded**: 録音アイコン、状態、時間、ファイル名、停止方法の説明
   - **Compact**: 録音アイコンと時間
   - **Minimal**: 録音アイコンのみ

#### 更新頻度

- タイマーで0.1秒ごとに更新
- `contentTransition(.numericText())`でスムーズな数値アニメーション

#### 停止方法

- ロック画面をタップして停止
- URL Scheme (`unlimited://stop`) で停止
- アプリ内の停止ボタンで停止

---

## バックグラウンド処理

### バックグラウンド録音

#### 設定

- **Info.plist**: `UIBackgroundModes = audio`
- **AVAudioSession**: `.playAndRecord`カテゴリ
- **バックグラウンドタスク**: `UIApplication.beginBackgroundTask()`

#### 実装詳細

1. **オーディオセッション設定**:
   ```swift
   try audioSession.setCategory(.playAndRecord, mode: .default, options: options)
   try audioSession.setActive(true, options: [])
   ```

2. **タイマー管理**:
   - 開始時刻を記録（`recordingStartTime`）
   - 現在時刻との差分で経過時間を計算
   - `RunLoop.current.add(timer, forMode: .common)`でバックグラウンドでも動作

3. **録音状態の監視**:
   - タイマー内で`audioRecorder.isRecording`を確認
   - 停止していた場合は自動で再開を試みる

### バックグラウンドタスク

- 録音開始時に`beginBackgroundTask()`を呼び出し
- バックグラウンド実行時間を確保
- 録音停止時に`endBackgroundTask()`で終了

---

## データモデル

### RecordingItem

録音アイテムのデータモデル

```swift
struct RecordingItem: Identifiable, Codable {
    let id: UUID
    let fileName: String
    let fileURL: URL
    let createdAt: Date
    let duration: TimeInterval
    var transcriptionResult: TranscriptionResult?
    var transcriptionState: TranscriptionState
}
```

**特徴**:
- ファイルURLは相対パス（ファイル名のみ）で保存
- 読み込み時にDocumentsディレクトリから再構築
- 文字起こし結果と状態を含む

### TranscriptionResult

文字起こし結果のデータモデル

```swift
struct TranscriptionResult: Identifiable, Codable {
    let id: UUID
    let text: String
    let fileName: String
    let createdAt: Date
}
```

### TranscriptionState

文字起こしの状態を表すenum

```swift
enum TranscriptionState: Codable {
    case idle
    case loading
    case processing
    case completed(TranscriptionResult)
    case error(String)
}
```

### TranscriptionLanguage

文字起こし言語の選択肢

```swift
enum TranscriptionLanguage: String, CaseIterable {
    case auto = "auto"
    case japanese = "ja"
    case english = "en"
}
```

---

## 依存関係

### Swift Package Manager

#### WhisperKit

- **リポジトリ**: `https://github.com/argmaxinc/WhisperKit.git`
- **バージョン**: `0.9.0`以降
- **用途**: ローカル音声文字起こし
- **モデル**: `small`（約500MB）

### フレームワーク

- **AVFoundation**: 音声録音・再生
- **ActivityKit**: Live Activities
- **WidgetKit**: ウィジェットとLive Activities
- **MediaPlayer**: ロック画面コントロール
- **SwiftUI**: UI構築
- **Combine**: リアクティブプログラミング

---

## 録音ファイル形式

### 形式

- **フォーマット**: MPEG-4 AAC (`.m4a`)
- **サンプルレート**: 44.1kHz
- **チャンネル**: モノラル（1チャンネル）
- **品質**: 高品質

### 保存場所

- **ディレクトリ**: `Documents`ディレクトリ
- **ファイル名**: `recording_{timestamp}.m4a`
- **例**: `recording_1706250000.123456.m4a`

---

## 文字起こし処理

### WhisperKit設定

- **モデル**: `small`
- **言語**: ユーザー選択（自動検出・日本語・英語）
- **デコーディングオプション**: 選択された言語に基づいて設定

### 処理フロー

1. **モデル読み込み**: 初回のみ（約500MB）
2. **音声ファイル読み込み**: 録音ファイルまたは選択ファイル
3. **文字起こし実行**: WhisperKitで処理
4. **結果整形**: 1文ずつ改行
5. **結果保存**: `RecordingItem`に保存

### 処理時間の目安

| 音声の長さ | 処理時間（iPhone 15 / 14 Pro） |
|-----------|------------------------------|
| 10分 | 約2-5分 |
| 30分 | 約7-15分 |
| 60分 | 約15-30分 |
| 90分 | 約20-40分 |

※処理時間は端末の性能や音声の内容によって異なります。

---

## UI/UX

### タブ構成

1. **録音一覧タブ**: 録音履歴の表示・管理
2. **録音タブ**: 録音開始・停止
3. **設定タブ**: 言語設定・文字起こし言語設定

### 録音画面

- **録音前**: 開始ボタンとファイル選択ボタン
- **録音中**: ストップウォッチ表示と停止ボタン
- **ロック画面**: Live Activityで状態表示

### 録音一覧

- **リスト表示**: ファイル名、時間、日付
- **文字起こし状態**: 開始ボタン・進捗・完了・エラー
- **結果表示**: 文字起こし結果へのナビゲーション

### 設定画面

- **アプリ言語**: 日本語・英語の切り替え
- **文字起こし言語**: 自動検出・日本語・英語の選択

---

## エラーハンドリング

### 録音エラー

- **権限拒否**: マイク権限が拒否された場合
- **ファイル作成失敗**: 録音ファイルの作成に失敗
- **録音失敗**: 録音開始に失敗

### 文字起こしエラー

- **モデル読み込み失敗**: WhisperKitモデルのダウンロード・読み込み失敗
- **処理失敗**: 文字起こし処理中のエラー

### エラー表示

- `TranscriptionState.error(String)`でエラーメッセージを保存
- UIでエラー状態を表示し、再試行ボタンを提供

---

## パフォーマンス最適化

### メモリ管理

- **Weak References**: タイマーやクロージャで`[weak self]`を使用
- **Model Unloading**: 文字起こし完了後にモデルをアンロード可能

### バッテリー最適化

- **効率的なタイマー**: 0.1秒間隔で更新
- **バックグラウンドタスク**: 必要最小限の時間のみ使用

### ストレージ管理

- **ファイル削除**: 録音削除時にファイルも削除
- **履歴管理**: 存在しないファイルは履歴から自動削除

---

## セキュリティとプライバシー

### データ保存

- **ローカル保存**: すべてのデータはデバイス内に保存
- **クラウド送信なし**: 音声データは外部に送信されません
- **UserDefaults**: 設定とメタデータのみ保存

### 権限

- **マイク権限**: 録音機能にのみ使用
- **説明文**: 権限リクエスト時に明確な説明を表示

---

## 今後の拡張可能性

### 機能追加候補

1. **iCloud Drive統合**: 録音ファイルをiCloudに自動保存
2. **ウェブアプリ連携**: バックエンドサーバーで録音内容を確認
3. **エクスポート機能**: 録音ファイルと文字起こし結果のエクスポート
4. **編集機能**: 録音ファイルのトリミング・編集
5. **共有機能**: 録音と文字起こし結果の共有

### 技術的改善

1. **バックグラウンド文字起こし**: アプリを閉じても文字起こしを継続
2. **複数ファイル処理**: 複数の録音ファイルを一括処理
3. **モデル選択**: ユーザーがモデルサイズを選択可能

---

## ビルドとデプロイ

### ビルド要件

- Xcode 15.0以上
- iOS 17.6 SDK以上
- Swift 5.0以上

### ビルド手順

1. リポジトリをクローン
2. Xcodeでプロジェクトを開く
3. Swift Package Managerで依存関係を解決
4. 実機またはシミュレータでビルド・実行

### App Store提出

- **バージョン**: 1.0
- **バンドルID**: `com.takumiNittono.word.Unlimited`
- **必要情報**: 
  - プライバシーポリシー
  - アプリ説明
  - スクリーンショット
  - マイク権限の説明

---

## トラブルシューティング

### よくある問題

1. **Live Activitiesが表示されない**
   - 設定 > Unlimited > Live Activitiesが有効か確認
   - iOS 16.2以上が必要

2. **バックグラウンドで録音が停止する**
   - Info.plistの`UIBackgroundModes`に`audio`が設定されているか確認
   - バッテリーセーバーモードが無効か確認

3. **文字起こしが遅い**
   - iPhone 14 Pro以降を推奨
   - 他のアプリを閉じてメモリを確保

4. **モデルのダウンロードに失敗**
   - Wi-Fi接続を確認
   - ストレージ容量を確認（500MB以上必要）

---

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

---

## 謝辞

- [WhisperKit](https://github.com/argmaxinc/WhisperKit) - Argmax Inc.
- [OpenAI Whisper](https://github.com/openai/whisper) - OpenAI

---

## 更新履歴

### Version 1.0 (2026-01-26)

- 初回リリース
- 録音機能
- 文字起こし機能
- Live Activities対応
- 多言語対応（日本語・英語）
- バックグラウンド録音対応

---

**最終更新**: 2026年1月26日
