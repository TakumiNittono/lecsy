了解。ここからは 「lecsy 全体像 + 要件定義（iOS→Supabase→Web→課金→AI）」 を、実装に落とせるレベルで“超詳しく”まとめる。
（このままCursor/Claude Codeに投げて設計・実装開始できる形）

0. ゴール（プロダクト定義）
lecsy がやること

iPhoneで講義を録音

iPhoneでローカル文字起こし（オフラインOK / 無制限）

ユーザーが明示操作で「テキストだけ」Supabase DBに保存

Webで全文閲覧・検索・コピー（無料）

Pro（月$2.99）でAI要約・Exam Mode（Webで実行）

重要な原則

音声はサーバーに送らない（基本）

自動同期しない（ユーザー操作のみ）

無料でも十分使える（Web閲覧・コピーは無料）

課金は「理解の速さ（AI）」に対して行う

1. システム全体像（アーキテクチャ）
[iOS App]
- 録音 (AVAudioEngine/AVAudioRecorder)
- ローカル文字起こし (WhisperKit/whisper.cpp)
- ローカル保存 (SQLite/CoreData/Files)
- Supabase Auth (Google + Apple)
- Save to Web (テキストのみPOST)

        ↓ HTTPS

[Supabase]
- Auth (OAuth: Google/Apple)
- Postgres DB (transcripts等)
- RLS (user_idで完全隔離)
- Storage (任意：将来、PDFエクスポートなど)
- Edge Functions (AI要約API)
- Stripe連携（Webhook + customer/pro状態）

        ↓

[Web App (Next.js on Vercel)]
- LP（/）
- Login（/login）
- App（/app）
- 講義一覧/詳細（無料）
- 検索/コピー（無料）
- AI要約/Exam Mode（Pro）

2. ユーザーフロー（体験設計）
2.1 初回ユーザー（ログイン不要で開始）

アプリ起動

録音開始（教室モードON推奨）

録音停止

ローカルで文字起こし

講義詳細で全文が読める

✅ ここまで完全無料・オフラインOK

2.2 Webに保存したいとき（ログインが発生）

講義詳細 → Save to Web 押下

未ログインなら → ログイン（Google/Apple）

成功したら → テキストをDBへ送信

Saved to Web 状態になる

Open on Web でWebの該当講義へ

2.3 Webで読む（無料）

Webログイン

一覧から講義を開く

全文閲覧 / 検索 / コピー（無料）

2.4 AI要約（Pro）

Webで ✨ Summarize / Exam Mode を押す

Proでなければ課金導線（Stripe or App Storeどちらか方針決める）

Proなら Edge Function がAI要約生成

結果を保存して即表示（キャッシュ）

3. iOS要件（超具体）
3.1 録音要件

形式：WAV or M4A（ローカル保存のみ）

推奨：48kHz / mono（後処理しやすい）

バックグラウンド録音：可能（授業想定）

教室モード：

ノイズ抑制/入力最適化（可能範囲）

マイク向きガイド（置き方のUI 1枚）

3.2 文字起こし要件（ローカル）

WhisperKit / whisper.cpp（端末内）

モデル：

初期：small or base（速度と精度のバランス）

文字起こしは録音後に実行（MVP）

進捗表示：

処理中 % / 残り時間の推定（可能なら）

エラー：

メモリ不足/モデル未DL/ストレージ不足を丁寧に案内

3.3 ローカル保存要件

最低限 Lecture を保持

lecture_id (UUID)

title

created_at

duration

audio_path

transcript_text

transcript_status（none/processing/done/error）

saved_to_web（bool）

web_transcript_id（nullable）

updated_at（編集反映用）

3.4 “Save to Web” 要件（重要）

ユーザー操作でのみ送信

送信対象：title / transcript_text / created_at（＋任意メタ）

送信失敗時：

キューに保存して再送（端末オンライン時）

“未送信”バッジ表示

成功時：

web_transcript_id を保存

“Saved to Web” 表示

Open on Web が有効化

3.5 ログイン要件（Auth）

Supabase Auth

Provider：

Google

Apple（必須：Googleを出すならAppleも出す）

ログインは以下で発生：

Save to Web

Open on Web（未ログインなら）

ログアウトは設定画面に置く

4. Supabase要件（DB/RLS/API）
4.1 テーブル設計（MVP）
transcripts

id uuid PK default gen_random_uuid()

user_id uuid NOT NULL references auth.users(id)

title text

content text NOT NULL

created_at timestamptz default now()

updated_at timestamptz default now()

source text default 'ios'（任意）

word_count int（任意：検索/制限用）

language text（任意）

summaries（AI結果のキャッシュ）

id uuid PK

transcript_id uuid references transcripts(id)

user_id uuid NOT NULL

summary text

key_points jsonb（箇条書き配列）

exam_mode jsonb（Q&Aや重要語）

model text

created_at timestamptz

updated_at timestamptz

subscriptions（Pro状態）

user_id uuid PK

status text（active/canceled/past_due）

provider text（stripe/appstore）

current_period_end timestamptz

updated_at timestamptz

4.2 RLS（絶対必須）

transcripts：自分のものだけselect/insert/update

summaries：自分のものだけselect/insert

subscriptions：自分のものだけselect（更新はサーバー側）

例（概念）：

auth.uid() = user_id

4.3 API設計（2パターン）
A) 速い（Supabase REST直叩き）

iOSが /rest/v1/transcripts に POST
→ 早いが、バリデーション薄い

B) きれい（Edge Function経由）※おすすめ

POST /functions/v1/save-transcript

バリデーション

サイズ制限

word_count計算

タイトル自動生成（将来）
→ “サービス品質”が上がる

lecsyは将来伸ばす前提だからB推奨。

5. Web要件（Next.js / Vercel）
5.1 ルーティング

/：LP

/login：ログイン

/app：ログイン必須

/app/t/:id：講義詳細（無料閲覧）

/app/t/:id/summary：要約（Pro）

5.2 無料機能（Web）

一覧表示（検索バー）

詳細表示（全文）

コピー（全文/選択）

検索（全文）

タイトル編集（無料でOK。UX上強い）

5.3 Pro機能（Web）

✨ Summarize

セクション分解（Heading + 1行要約）

Exam Mode（重要語・Q&A・出題予想）

エクスポート（PDF/Markdown）は後でOK

5.4 課金導線

Proボタン押下時に課金画面へ

“無料でも十分 → でも時間節約は有料”を徹底

課金後は即反映（subscriptions.status=active）

6. 課金モデル要件（現実運用）
6.1 プラン

Free：ローカル文字起こし無制限 + Web閲覧/検索/コピー無料

Pro：$2.99/month（AI要約・Exam Mode）

6.2 AIコスト制御（裏のフェアリミット）

表では “Unlimited” を維持しつつ、裏で守る：

例：1日 20回 / 月 400回 など

超えたら：

“Today’s limit reached. Try again tomorrow.”

※ この数は後で利用データ見て調整でOK

7. “iOS文字→DB” 送信の詳細（ここがあなたの質問の核心）
7.1 送信トリガー

講義詳細画面の Save to Web ボタン押下

7.2 送信データ（JSON）

title

content（文字起こし）

created_at（端末側の時間）

optional：duration, language, app_version

7.3 認証

Supabase Authの access token をBearerで添付
Supabaseが auth.uid() を判定 → user_idに紐付く

7.4 DB保存

RLSにより 自分の行だけ insert 可能

成功時に transcripts.id を返す

iOS側で web_transcript_id に保存

7.5 再送（重要）

ネットワーク失敗時に備える：

ローカルに “pending uploads” を保持

次回オンライン時に自動再送（※ユーザー明示操作の範囲内：一度「保存」押したものに限る）

8. 画面要件（iOS / Web）
iOS画面（MVP）

Home（Record）

Library（講義一覧）

Lecture Detail（全文、Save to Web、Open Web、Copy）

Login（Google/Apple）

Settings（モデルDL、ストレージ、ログアウト）

Web画面（MVP）

LP（右上にLogin、主CTAはGet Started）

Login

App：講義一覧

App：講義詳細（無料）

App：Summary/Exam（Pro）

9. 非機能要件（品質・安全）
セキュリティ

RLS必須

APIキーはサーバー側のみ

AI要約は必ずEdge Function経由（課金チェック含む）

プライバシー

音声は端末内

テキストはユーザー操作時のみ送信

Privacy Policyに明記

パフォーマンス

Webは全文表示の仮想スクロール（必要なら）

検索はDB全文検索 or クライアント検索（初期は後者でもOK）

可用性

Supabase障害時：Webは影響、iOSローカルは継続可能（強い）

10. 実装マイルストーン（作る順番）
Phase 0（今週）

Supabaseプロジェクト作成

Auth（Google/Apple）設定

DB（transcripts）+ RLS

Phase 1（MVP）

iOS：録音→ローカル文字起こし→一覧/詳細

iOS：Save to Web（テキストのみ）

Web：ログイン→一覧→詳細→コピー

Phase 2（収益化）

Stripe（またはApp Store課金方針決定）

subscriptions管理

Edge Functionで要約生成 + 保存

WebでSummarize/Exam UI

Phase 3（差別化）

教室モード強化（音質最適化）

セクション分解

用語辞書（授業向け）

エクスポート/共有